<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="final_educational_student_template">
        <t t-call="web.html_container">
            <head>
                <meta charset="UTF-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                <link rel="preconnect" href="https://fonts.googleapis.com"/>
                <link rel="preconnect" href="https://fonts.gstatic.com"/>
                <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet"/>
                <style>
                    body {
                        font-size: 12px !important;
                    }
                    .container {
                        max-width: 100% !important;
                        width: 100% !important;
                    }
                    .table-container {
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                        margin-top: 10px;
                        min-width: 1000px;
                        white-space: nowrap;
                    }
                    table {
                        border: 1px solid #000 !important;
                        background-color: #EEEEEE !important;
                        width: 100% !important;
                        text-align: center !important;
                        border-collapse: collapse !important;
                        min-width: 1000px;
                        white-space: nowrap;
                    }
                    .table {
                        border: 0px solid #fff !important;
                        background-color: #fff !important;
                        text-align: center !important;
                    }
                    td {
                        white-space: nowrap !important;
                        padding: 5px !important;
                    }
                    td, th {
                        border: 1px solid #000 !important;
                        text-transform: capitalize !important;
                        padding: 5px !important;
                    }
                    table tr:nth-child(even) {
                        background: #D0E4F5 !important;
                    }
                    table thead {
                        border-bottom: 2px solid #000 !important;
                    }
                    table thead th {
                        font-size: 13px !important;
                        font-weight: 600 !important;
                        color: #3B4345 !important;
                        text-align: center !important;
                        vertical-align: inherit !important;
                        padding: 5px !important;
                    }
                    table tfoot td {
                        font-size: 14px !important;
                    }
                    table tfoot .links {
                        text-align: right !important;
                    }
                    table tfoot .links a {
                        display: inline-block !important;
                        background: #1C6EA4 !important;
                        color: #FFFFFF !important;
                        padding: 2px 8px !important;
                        border-radius: 5px !important;
                    }
                    .table  &gt; thead  &gt; tr  &gt; th, .table  &gt; tbody  &gt; tr  &gt; th, .table  &gt; tfoot  &gt; tr  &gt; th, .table  &gt; thead  &gt; tr  &gt; td, .table  &gt; tbody  &gt; tr  &gt; td, .table  &gt; tfoot  &gt; tr  &gt; td {
                        padding: 5px !important;
                        line-height: 1.42857143 !important;
                        vertical-align: middle !important;
                        border-top: 1px solid #dddddd !important;
                    }
                    .print {
                        display: none;
                    }
                  
                    @media print {
                    .print {
                                            display: block;
                                        }
                                        .btn-print {
                                            display: none;
                                        }
                    .table-container {
                        overflow: visible !important;
                        -webkit-overflow-scrolling: auto !important;
                    }
                    .table-container table {
                        min-width: auto !important;
                        white-space: normal !important;
                    }
                    table {
                        page-break-inside: auto;
                        font-size: 10px !important;
                    }
                    .page {
                        page-break-before: always;
                    }
                    .page:first-child {
                        page-break-before: avoid;
                    }
                    .page-break {
                        display: none;
                    }
                }
                </style>
            </head>
            <t t-if="not classes">
                <h3>No records found in evaluations for the classes</h3>
            </t>
            <button onclick="javascript:window.print()" class="btn-print">Print</button>
            <t t-foreach="classes" t-as="curr_class">
                <div t-attf-style="page-break-after: always; padding-top: 32px; direction: #{'rtl' if arabic_report else 'ltr'};">
                    <div class="row">
                        <br/>
                        <t t-if="arabic_report == true">
                            <h4 style="text-align:center;direction: rtl;">
                                درجات التلاميذ للعام الدراسي
                                <span t-esc="year"/>
                                طبقا للقرار الوزاري (
                                <span t-esc="ministerial_number"/>
                                )
                                (
                                <span t-esc="term_ar"/>
                                )
                                للمادة
                                <span t-esc="syllabus_ar"/>
                                للصف
                                <span t-esc="garde_ar"/>
                                فصل
                                <span t-esc="curr_class.get('name', '')"/>
                            </h4>
                        </t>
                        <t t-if="arabic_report == false">
                            <h4 style="text-align:center;">
                                Students Grades for year
                                <span t-esc="year"/>
                                according to ministry (
                                <span t-esc="ministerial_number"/>
                                )
                                (
                                <span t-esc="term_en"/>
                                )
                                for subject
                                <span t-esc="syllabus_en"/>
                                for grade
                                <span t-esc="garde_en"/>
                                class
                                <span t-esc="curr_class.get('name', '')"/>
                            </h4>
                        </t>
                    </div>
                    <hr/>
                    <div class="table-container">
                        <table class="table blueTable" t-att-dir="arabic_report and 'rtl' or 'ltr'">
                            <thead>
                                <tr>
                                    <th rowspan="3" class="name-col">
                                        <t t-if="arabic_report == false">
                                            <span>Serial no</span>
                                        </t>
                                        <t t-if="arabic_report == true">
                                            <span>م</span>
                                        </t>
                                    </th>
                                    <th rowspan="3">
                                        <t t-if="arabic_report == false">
                                            <span>Student</span>
                                        </t>
                                        <t t-if="arabic_report == true">
                                            <span>الاسم</span>
                                        </t>
                                    </th>
                                    <t t-foreach="assessments_times" t-as="times">
                                        <t t-set="assessments" t-value="assessments_data"/>
                                        <t t-set="assessments_count" t-value="len(assessments)"/>
                                        <t t-if="grading_method != 'q_colors'">
                                            <th t-att-colspan="assessments_count+1">
                                                <strong>
                                                    <span t-esc="times.get('name','')"/>
                                                </strong>
                                            </th>
                                        </t>
                                        <t t-if="grading_method == 'q_colors'">
                                            <th t-att-colspan="assessments_count">
                                                <strong>
                                                    <span t-esc="times.get('name','')"/>
                                                </strong>
                                            </th>
                                        </t>
                                    </t>
                                    <t t-if="grading_method != 'q_colors'">
                                        <th rowspan="2">
                                            <t t-if="arabic_report == false">
                                                <span>Total Assessments</span>
                                            </t>
                                            <t t-if="arabic_report == true">
                                                <span>مجموع الشهور</span>
                                            </t>
                                        </th>
                                    </t>
                                    <t t-if="grading_method != 'q_colors'">
                                        <th rowspan="2">
                                            <t t-if="arabic_report == false">
                                                <span>Average</span>
                                            </t>
                                            <t t-if="arabic_report == true">
                                                <span>المتوسط</span>
                                            </t>
                                        </th>
                                    </t>
                                    <t t-foreach="distributions_data" t-as="distribution">
                                        <th rowspan="2">
                                            <span t-esc="distribution.get('name','')"/>
                                        </th>
                                    </t>
                                    <t t-if="distributions_data and grading_method != 'q_colors'">
                                        <th rowspan="2">
                                            <t t-if="arabic_report == false">
                                                <span>Total Distributions</span>
                                            </t>
                                            <t t-if="arabic_report == true">
                                                <span>مجموع التوزيعات</span>
                                            </t>
                                        </th>
                                    </t>
                                    <t t-if="grading_method != 'q_colors'">
                                        <th rowspan="2">
                                            <t t-if="arabic_report == false">
                                                <span>Final Total</span>
                                            </t>
                                            <t t-if="arabic_report == true">
                                                <span>الاجمالي النهائي</span>
                                            </t>
                                        </th>
                                    </t>
                                </tr>
                                <tr>
                                    <t t-foreach="assessments_times" t-as="times">
                                        <t t-foreach="assessments_data" t-as="assessment">
                                            <th>
                                                <span t-esc="assessment.get('name','')"/>
                                            </th>
                                        </t>
                                        <t t-if="assessments_data and grading_method != 'q_colors'">
                                            <th>
                                                <t t-if="arabic_report == false">
                                                    <span>Total</span>
                                                </t>
                                                <t t-if="arabic_report == true">
                                                    <span>اجمالي</span>
                                                </t>
                                            </th>
                                        </t>
                                    </t>
                                </tr>
                                <t t-if="grading_method != 'q_colors'">
                                    <tr>
                                        <t t-set="total_max_score" t-value="0"/>
                                        <t t-foreach="assessments_times" t-as="times">
                                            <t t-set="max_score" t-value="0"/>
                                            <t t-foreach="assessments_data" t-as="assessment">
                                                <t t-set="max_score" t-value="max_score+assessment.get('maximum','')"/>
                                                <th>
                                                    <span t-esc="assessment.get('maximum','')"/>
                                                </th>
                                            </t>
                                            <th>
                                                <span t-esc="max_score"/>
                                            </th>
                                            <t t-set="total_max_score" t-value="total_max_score+max_score"/>  
                                        </t>
                                        <th>
                                            <span t-esc="total_max_score"/>
                                        </th>
                                        <t t-if="assessments_times">
                                            <t t-set="avarage"  t-value="total_max_score/len(assessments_times)"/>
                                            <th>
                                                <span>
                                                    <t t-esc="avarage"/>
                                                </span>
                                            </th>
                                        </t>
                                        <t t-set="distribution_maximum" t-value="0"/>
                                        <t t-foreach="distributions_data" t-as="distribution">
                                            <th>
                                                <span>
                                                    <t t-esc="distribution.get('maximum','')"/>
                                                </span>
                                            </th>
                                            <t t-set="distribution_maximum" t-value="distribution_maximum+distribution.get('maximum','')"/> 
                                        </t>
                                        <th>
                                            <span>
                                                <t t-esc="distribution_maximum"/>
                                            </span>
                                        </th>
                                        <th>
                                            <span>
                                                <!-- <t t-esc="avarage+distribution_maximum"/> -->
                                                <t t-esc="total_max_score+distribution_maximum"/>
                                            </span>
                                        </th>
                                    </tr>
                                </t>
                            </thead>
                            <tbody>
                                <t t-set="i" t-value="1"/>
                                <t t-foreach="curr_class.get('students_data',[])" t-as="std">
                                    <!-- إضافة شرط للتأكد إن الطالب ينتمي للفصل الحالي -->
                                    <t t-if="not std.get('class_id') or std.get('class_id') == curr_class.get('id')">
                                        <tr>
                                            <td>
                                                <span t-esc="i"/>
                                            </td>
                                            <t t-set="i" t-value="i+1"/>
                                            <td t-att-dir="arabic_report and 'rtl' or 'ltr'">
                                                <t t-if="arabic_report == false">
                                                    <span>
                                                        <t t-esc="std.get('en_full_name','')"/>
                                                    </span>
                                                </t>
                                                <t t-if="arabic_report == true">
                                                    <span>
                                                        <t t-esc="std.get('ar_full_name','')"/>
                                                    </span>
                                                </t>
                                            </td>
                                            <!-- عرض درجات الـ Assessments لكل Assessment Time -->
                                            <t t-foreach="assessments_times" t-as="times">
                                                <t t-set="current_time_assessments" t-value="[]"/>
                                                <t t-foreach="std.get('assessments', [])" t-as="student_assessment_time">
                                                    <t t-if="student_assessment_time.get('time') == times.get('name')">
                                                        <t t-set="current_time_assessments" t-value="student_assessment_time.get('assessments', [])"/>
                                                </t>
                                                </t>
                                                <t t-set="time_total" t-value="0"/>
                                                <t t-foreach="assessments_data" t-as="assessment_config">
                                                    <t t-set="found_score" t-value="0"/>
                                                    <t t-foreach="current_time_assessments" t-as="student_assessment">
                                                        <t t-if="student_assessment.get('assessment_id') == assessment_config.get('id')">
                                                            <t t-set="found_score" t-value="student_assessment.get('scaled_score', 0)"/>
                                                            <t t-set="time_total" t-value="time_total + found_score"/>
                                                    </t>
                                                    </t>
                                                    <td>
                                                        <span t-esc="'%.1f' % found_score"/>
                                                    </td>
                                                </t>
                                                <!-- مجموع الـ Assessment Time -->
                                                <t t-if="assessments_data and grading_method != 'q_colors'">
                                                    <td>
                                                        <span t-esc="'%.1f' % time_total"/>
                                                    </td>
                                                </t>
                                            </t>
                                            <!-- مجموع كل الـ Assessments -->
                                            <t t-if="grading_method != 'q_colors'">
                                                <td>
                                                    <span t-esc="'%.1f' % std.get('total_assessments', 0)"/>
                                                </td>
                                            </t>
                                            <!-- متوسط الـ Assessments -->
                                            <t t-if="grading_method != 'q_colors'">
                                                <td>
                                                    <t t-set="assessment_average" t-value="std.get('total_assessments', 0) / len(assessments_times) if assessments_times else 0"/>
                                                    <span t-esc="'%.1f' % assessment_average"/>
                                                </td>
                                            </t>
                                            <!-- عرض درجات الـ Distributions -->
                                            <t t-foreach="distributions_data" t-as="distribution_config">
                                                <t t-set="found_dist_score" t-value="0"/>
                                                <t t-foreach="std.get('distributions', [])" t-as="student_distribution">
                                                    <t t-if="student_distribution.get(str('dis_id')) == distribution_config.get(str('id'))">
                                                        <t t-set="found_dist_score" t-value="student_distribution.get('score', 0)"/>
                                                </t>
                                                </t>
                                                <td>
                                                    <span t-esc="'%.1f' % found_dist_score"/>
                                                </td>
                                            </t>
                                            <!-- مجموع الـ Distributions -->
                                            <t t-if="distributions_data and grading_method != 'q_colors'">
                                                <td>
                                                    <span t-esc="'%.1f' % std.get('total_distributions', 0)"/>
                                                </td>
                                            </t>
                                            <!-- الاجمالي النهائي -->
                                            <t t-if="grading_method != 'q_colors'">
                                                <td>
                                                    <span t-esc="'%.1f' % std.get('final_total', 0)"/>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    <t t-if="arabic_report == true">
                        <table class="table" style="direction:rtl;width:100%;">
                            <tr>
                                <td style="text-align:center;width:33%;" class="table">مدرس المادة</td>
                                <td style="text-align:center;width:33%;" class="table">رئيس القسم</td>
                                <td style="text-align:center;width:33%;" class="table">مدير المدرسة</td>
                            </tr>
                        </table>
                    </t>
                    <div style="page-break-after: always;"/>
                </div>
            </t>
        </t>
    </template>
</odoo>