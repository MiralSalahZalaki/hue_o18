<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="ig_monthly_report_template">
        <t t-call="web.html_container">
            <head>
                <meta charset="UTF-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                <link rel="preconnect" href="https://fonts.googleapis.com"/>
                <link rel="preconnect" href="https://fonts.gstatic.com" />
                <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet"/>
                <style>
                    .style1{
                        background-color: rgba(0, 0, 0, 0.2) !important;
                    }
                    .style2{
                        background-color: blue;
                    }
                    .o_report_layout_boxed table tbody tr td:last-child {
                        background-color: unset !important;
                    }
                    .table-bordered &gt; tbody &gt; tr &gt; td{
                        border: 1px solid #555555 !important;
                    }
                    #wrapwrap table.table.table-bordered td{
                        vertical-align: middle !important;
                        text-align: center !important;
                        padding: 2px 4px !important;
                    }
                    #wrapwrap table.table.table-bordered{
                        font-size: 12px !important;
                        font-weight: 600 !important;
                        border-collapse: collapse;
                        margin-bottom: 15px !important;
                    }
                    .table-bordered &gt; thead &gt; tr &gt; th{
                        border: 1px solid #555555 !important;
                        text-align: center !important;
                        padding: 4px 6px !important;
                        background-color: #f5f5f5 !important;
                        font-weight: bold !important;
                    }
                    .assessment-title {
                        background-color: #e6f2ff !important;
                        font-weight: bold !important;
                        font-size: 14px !important;
                    }
                    .total-row {
                        background-color: #f0f0f0 !important;
                        font-weight: bold !important;
                    }
                    .student-header {
                        margin-bottom: 20px;
                        padding: 10px;
                        border-bottom: 2px solid #ddd;
                    }
                </style>
            </head>

             <div class="page">
                    <!-- Loop through each student -->
                    <t t-foreach="students_data" t-as="student" t-as-index="student_index">
                        <div class="student-header">
                            <h1 style="text-align: center; margin-bottom: 20px;">Monthly Report</h1>
                            
                            <!-- Assessment Times Display -->
                            <div class="col-xs-12" style="margin-bottom: 10px;">
                                <strong>Assessments Adding Time: </strong>
                                <t t-foreach="assessment_times" t-as="assessment_time" t-as-index="ass_index">
                                    <span t-esc="assessment_time.get('name','')"/>
                                    <t t-if="ass_index_last != True"> - </t>
                                </t>
                            </div>
                            
                            <!-- Student Information -->
                            <div class="row">
                                <div class="col-xs-4">
                                    <strong>Student Name: </strong>
                                    <span t-esc="student.get('name', '')"/>
                                </div>
                                <div class="col-xs-4">
                                    <strong>Grade: </strong>
                                    <span t-esc="student.get('grade_name', '')"/>
                                </div>
                                <div class="col-xs-4">
                                    <strong>Class: </strong>
                                    <span t-esc="student.get('class_id', '')"/>
                                </div>
                            </div>
                            
                            <t t-if="student.get('seat_number')">
                                <div class="row">
                                    <div class="col-xs-4">
                                        <strong>Seat Number: </strong>
                                        <span t-esc="student.get('seat_number', '')"/>
                                    </div>
                                </div>
                            </t>
                        </div>

                        <!-- Assessment Tables -->
                        <div class="row">
                            <div class="col-xs-12">
                                <t t-foreach="student.get('assessment_times_data', [])" t-as="assessment_data">
                                    <!-- Assessment Time Title -->
                                    <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2e5894;">
                                        <t t-esc="assessment_data.get('assessment_time_name', '')"/>
                                    </h3>
                                    
                                    <!-- Subjects Table for this Assessment Time -->
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr class="assessment-title">
                                                <th style="width: 5%;">#</th>
                                                <th style="width: 70%;">Subject</th>
                                                <th style="width: 25%;">Range</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="assessment_data.get('subjects', [])" t-as="subject">
                                                <tr>
                                                    <td t-esc="subject.get('sequence', '') + 1"/>
                                                    <td style="text-align: left; padding-left: 10px;" t-esc="subject.get('subject_name', '')"/>
                                                    <td t-esc="subject.get('score', 0)"/>
                                                </tr>
                                            </t>
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <th colspan="2" style="text-align: center;">TOTAL</th>
                                                <th t-esc="assessment_data.get('total_score', 0)"/>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </t>
                            </div>
                        </div>

                        <!-- Page break after each student (except the last one) -->
                        <t t-if="student_index_last != True">
                            <div style="page-break-after: always;"/>
                        </t>
                    </t>


                    <!-- Top Rank Students Table -->
                    <t t-if="top_rank != 0">
                        <div class="row mt30">
                            <div class="col-xs-12">
                                <h4 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">
                                    <strong>Top Rank Students</strong>
                                </h4>
                            </div>
                        </div>

                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Prepare list of student scores -->
                                <t t-set="student_scores" t-value="[]"/>
                                <t t-foreach="students_data" t-as="student">
                                    <t t-set="total_score" t-value="0"/>
                                    <t t-foreach="student.get('assessment_times_data', [])" t-as="assessment_data">
                                        <t t-set="total_score" t-value="total_score + assessment_data.get('total_score', 0)"/>
                                    </t>
                                    <t t-set="student_scores" t-value="student_scores + [(student.get('name', ''), total_score)]"/>
                                </t>

                                <!-- Sort by score descending and limit to top_rank -->
                                <t t-set="sorted_students" t-value="sorted(student_scores, key=lambda x: x[1], reverse=True)[:top_rank]"/>
                                
                                <!-- Display top-ranked students -->
                                <t t-foreach="sorted_students" t-as="student_score">
                                    <tr>
                                        <td><span t-esc="student_score[0]"/></td>
                                        <td><span t-esc="student_score[1]"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                    
                </div>
        </t>
    </template>
</odoo>